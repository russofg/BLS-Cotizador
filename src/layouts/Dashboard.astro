---
import Base from "./Base.astro";

interface Props {
  title: string;
  activeSection?: string;
}

const { title, activeSection } = Astro.props;
---

<Base title={title}>
  <div
    class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200"
    data-dashboard-content
  >
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-2 sm:px-4">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <h1
                class="text-xl sm:text-2xl font-bold text-primary-600 dark:text-primary-400 truncate"
              >
                BLS Cotizador
              </h1>
            </div>

            <!-- Desktop navigation -->
            <div class="hidden md:ml-6 md:flex md:space-x-4 xl:space-x-8">
              <a
                href="/dashboard"
                class={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  activeSection === "dashboard"
                    ? "border-primary-500 text-gray-900 dark:text-white"
                    : "border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-500"
                }`}
              >
                Dashboard
              </a>
              <a
                href="/items"
                class={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  activeSection === "items"
                    ? "border-primary-500 text-gray-900 dark:text-white"
                    : "border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-500"
                }`}
              >
                Gesti√≥n de Items
              </a>
              <a
                href="/clients"
                class={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  activeSection === "clients"
                    ? "border-primary-500 text-gray-900 dark:text-white"
                    : "border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-500"
                }`}
              >
                Clientes
              </a>
              <a
                href="/quotes"
                class={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  activeSection === "quotes"
                    ? "border-primary-500 text-gray-900 dark:text-white"
                    : "border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-500"
                }`}
              >
                Cotizaciones
              </a>
              <a
                href="/config"
                class={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  activeSection === "config"
                    ? "border-primary-500 text-gray-900 dark:text-white"
                    : "border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-500"
                }`}
              >
                Configuraci√≥n
              </a>
            </div>
          </div>

          <div class="flex items-center space-x-2 sm:space-x-4">
            <!-- Mobile menu button -->
            <button
              id="mobile-menu-button"
              type="button"
              class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
              aria-expanded="false"
              aria-label="Men√∫ principal"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>

            <!-- User menu -->
            <div class="relative">
              <button
                id="user-menu-button"
                type="button"
                class="flex items-center space-x-1 sm:space-x-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 rounded-md p-1 sm:p-2"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <!-- Avatar del usuario -->
                <div
                  class="h-6 w-6 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-xs font-medium relative overflow-hidden flex-shrink-0"
                >
                  <span id="user-avatar-initials">U</span>
                  <img
                    id="user-avatar-image"
                    class="h-full w-full object-cover hidden"
                    alt="Avatar"
                  />
                </div>
                <span id="user-name" class="hidden sm:inline">Usuario</span>
                <svg
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>

              <!-- Dropdown menu -->
              <div
                id="user-menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-50 border border-gray-200 dark:border-gray-700"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="user-menu-button"
              >
                <div
                  class="px-4 py-2 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-gray-700"
                >
                  <span id="user-email" class="break-words"
                    >usuario@ejemplo.com</span
                  >
                </div>
                <a
                  href="/profile"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  role="menuitem"
                >
                  Mi perfil
                </a>
                <a
                  href="/config"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  role="menuitem"
                >
                  Configuraci√≥n
                </a>
                <button
                  id="logout-button"
                  class="block w-full text-left px-4 py-2 text-sm text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
                  role="menuitem"
                >
                  Cerrar sesi√≥n
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile menu panel -->
      <div
        id="mobile-menu"
        class="hidden md:hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-md"
      >
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a
            href="/dashboard"
            class={`block px-3 py-2 rounded-md text-base font-medium ${
              activeSection === "dashboard"
                ? "bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            }`}
          >
            Dashboard
          </a>
          <a
            href="/items"
            class={`block px-3 py-2 rounded-md text-base font-medium ${
              activeSection === "items"
                ? "bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            }`}
          >
            Gesti√≥n de Items
          </a>
          <a
            href="/clients"
            class={`block px-3 py-2 rounded-md text-base font-medium ${
              activeSection === "clients"
                ? "bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            }`}
          >
            Clientes
          </a>
          <a
            href="/quotes"
            class={`block px-3 py-2 rounded-md text-base font-medium ${
              activeSection === "quotes"
                ? "bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            }`}
          >
            Cotizaciones
          </a>
          <a
            href="/config"
            class={`block px-3 py-2 rounded-md text-base font-medium ${
              activeSection === "config"
                ? "bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
            }`}
          >
            Configuraci√≥n
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-4 sm:py-6 px-2 sm:px-4 md:px-6 lg:px-8">
      <slot />
    </main>
  </div>
</Base>

<script>
  import { authService } from "../utils/auth";
  import { notifications } from "../utils/notifications.js";

  document.addEventListener("DOMContentLoaded", async () => {
    // Funci√≥n para generar iniciales
    function generateInitials(name: string): string {
      if (!name) return "U";
      const words = name.trim().split(/\s+/);
      if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
      } else {
        return words[0].slice(0, 2).toUpperCase();
      }
    }

    // Funci√≥n para actualizar el avatar del usuario
    function updateUserAvatar(user: any) {
      const avatarInitials = document.getElementById("user-avatar-initials");
      const avatarImage = document.getElementById(
        "user-avatar-image"
      ) as HTMLImageElement;

      if (!avatarInitials || !avatarImage) return;

      if (user.avatar) {
        // Mostrar imagen del avatar
        avatarImage.src = user.avatar;
        avatarImage.classList.remove("hidden");
        avatarInitials.style.display = "none";
      } else {
        // Mostrar iniciales
        avatarImage.classList.add("hidden");
        avatarInitials.style.display = "flex";
        avatarInitials.textContent = generateInitials(
          user.nombre || user.email
        );
      }
    }

    // Load user info with retry logic and auth state listener
    const loadUserInfo = async (retries = 3) => {
      try {
        const user = await authService.getCurrentUser();
        if (user) {
          const userNameElement = document.getElementById("user-name");
          const userEmailElement = document.getElementById("user-email");

          if (userNameElement) {
            userNameElement.textContent = user.nombre || "Usuario";
          }
          if (userEmailElement) {
            userEmailElement.textContent = user.email || "";
          }

          // Actualizar avatar
          updateUserAvatar(user);

          return true;
        } else if (retries > 0) {
          // Retry after a short delay
          setTimeout(() => loadUserInfo(retries - 1), 500);
        }
      } catch (error) {
        console.error("Error loading user info:", error);
        if (retries > 0) {
          setTimeout(() => loadUserInfo(retries - 1), 500);
        }
      }
      return false;
    };

    // Also listen for auth state changes to update user info immediately
    authService.onAuthStateChange(async (user) => {
      if (user) {
        // Wait a bit for Firestore data to be available
        setTimeout(async () => {
          const currentUser = await authService.getCurrentUser();
          if (currentUser) {
            const userNameElement = document.getElementById("user-name");
            const userEmailElement = document.getElementById("user-email");

            if (userNameElement) {
              userNameElement.textContent = currentUser.nombre || "Usuario";
            }
            if (userEmailElement) {
              userEmailElement.textContent = currentUser.email || "";
            }

            // Actualizar avatar
            updateUserAvatar(currentUser);
          }
        }, 1000);
      }
    });

    await loadUserInfo();

    // Escuchar eventos de actualizaci√≥n de avatar
    window.addEventListener("avatarUpdated", (event: any) => {
      console.log("üîî Avatar updated event received:", event.detail);
      const { avatar, user } = event.detail;
      // Actualizar el avatar en el dashboard
      updateUserAvatar(user);
    });

    // User menu toggle
    const userMenuButton = document.getElementById("user-menu-button");
    const userMenu = document.getElementById("user-menu");

    userMenuButton?.addEventListener("click", () => {
      const isHidden = userMenu?.classList.contains("hidden");
      if (isHidden) {
        userMenu?.classList.remove("hidden");
      } else {
        userMenu?.classList.add("hidden");
      }
    });

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
      if (
        !userMenuButton?.contains(e.target as Node) &&
        !userMenu?.contains(e.target as Node)
      ) {
        userMenu?.classList.add("hidden");
      }
    });

    // Close menu when clicking on menu items
    userMenu?.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (target.tagName === "A") {
        userMenu.classList.add("hidden");
      }
    });

    // Logout functionality
    const logoutButton = document.getElementById("logout-button");
    logoutButton?.addEventListener("click", async () => {
      const result = await notifications.confirm(
        "Cerrar sesi√≥n",
        "¬øEst√°s seguro que deseas salir del sistema?",
        "S√≠, cerrar sesi√≥n",
        "Cancelar"
      );

      if (result.isConfirmed) {
        try {
          notifications.loading("Cerrando sesi√≥n", "Por favor espera...");
          await authService.signOut();
          notifications.success("¬°Hasta luego!", "Sesi√≥n cerrada exitosamente");

          setTimeout(() => {
            window.location.href = "/login";
          }, 1000);
        } catch (error) {
          console.error("Logout error:", error);
          notifications.error("Error", "No se pudo cerrar la sesi√≥n");
        }
      }
    });
  });

  // Mobile menu functionality
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");

  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener("click", () => {
      const expanded =
        mobileMenuButton.getAttribute("aria-expanded") === "true";

      if (expanded) {
        mobileMenuButton.setAttribute("aria-expanded", "false");
        mobileMenu.classList.add("hidden");
        // Change hamburger to menu icon
        mobileMenuButton.innerHTML = `
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        `;
      } else {
        mobileMenuButton.setAttribute("aria-expanded", "true");
        mobileMenu.classList.remove("hidden");
        // Change to X icon
        mobileMenuButton.innerHTML = `
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        `;
      }
    });

    // Close mobile menu on resize to desktop
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) {
        // 768px is md breakpoint in Tailwind
        mobileMenu.classList.add("hidden");
        mobileMenuButton.setAttribute("aria-expanded", "false");
        mobileMenuButton.innerHTML = `
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        `;
      }
    });
  }
</script>

<!-- Sistema de Notificaciones Global -->
<div
  id="notification-container"
  class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none"
>
  <!-- Las notificaciones se insertar√°n aqu√≠ din√°micamente -->
</div>

<script>
  // Sistema global de notificaciones
  class NotificationSystem {
    private container: HTMLElement | null = null;
    private notifications: Map<string, HTMLElement> = new Map();
    private lastNotificationTime: Map<string, number> = new Map();
    private notificationCooldown: number = 30 * 60 * 1000; // 30 minutos

    constructor() {
      this.container = document.getElementById("notification-container");
      this.init();
    }

    private init() {
      // Solicitar permisos para notificaciones push
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    /**
     * Muestra una notificaci√≥n en pantalla
     */
    show(
      message: string,
      type: "success" | "error" | "info" | "warning" = "info",
      duration: number = 5000,
      forceShow: boolean = false
    ) {
      // Crear clave √∫nica para esta notificaci√≥n
      const notificationKey = `${type}-${message}`;
      const now = Date.now();

      // Verificar si ya se mostr√≥ recientemente (solo para notificaciones autom√°ticas)
      if (!forceShow && this.lastNotificationTime.has(notificationKey)) {
        const lastTime = this.lastNotificationTime.get(notificationKey)!;
        if (now - lastTime < this.notificationCooldown) {
          console.log("Notificaci√≥n omitida por cooldown:", message);
          return;
        }
      }

      // Registrar tiempo de esta notificaci√≥n
      this.lastNotificationTime.set(notificationKey, now);

      const id = `notification-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

      const notification = document.createElement("div");
      notification.id = id;
      notification.className = `pointer-events-auto transform transition-all duration-300 translate-x-full ${
        type === "success"
          ? "bg-green-500 text-white"
          : type === "error"
            ? "bg-red-500 text-white"
            : type === "warning"
              ? "bg-orange-500 text-white"
              : "bg-blue-500 text-white"
      } p-4 rounded-lg shadow-lg max-w-sm`;

      notification.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            ${
              type === "success"
                ? "‚úÖ"
                : type === "error"
                  ? "‚ùå"
                  : type === "warning"
                    ? "‚ö†Ô∏è"
                    : "‚ÑπÔ∏è"
            }
          </div>
          <div class="flex-1">
            <p class="text-sm font-medium">${message}</p>
          </div>
          <button onclick="window.notificationSystem?.remove('${id}')" class="flex-shrink-0 text-white hover:text-gray-200 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `;

      if (this.container) {
        this.container.appendChild(notification);
        this.notifications.set(id, notification);

        // Animar entrada
        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        // Auto-remover despu√©s del tiempo especificado
        if (duration > 0) {
          setTimeout(() => {
            this.remove(id);
          }, duration);
        }
      }
    }

    /**
     * Remueve una notificaci√≥n espec√≠fica
     */
    remove(id: string) {
      const notification = this.notifications.get(id);
      if (notification) {
        notification.classList.add("translate-x-full");
        setTimeout(() => {
          notification.remove();
          this.notifications.delete(id);
        }, 300);
      }
    }

    /**
     * Limpia todas las notificaciones
     */
    clear() {
      this.notifications.forEach((notification, id) => {
        this.remove(id);
      });
    }

    /**
     * Muestra notificaci√≥n push del navegador
     */
    showPushNotification(
      title: string,
      message: string,
      options?: NotificationOptions
    ) {
      if ("Notification" in window && Notification.permission === "granted") {
        const notification = new Notification(title, {
          body: message,
          icon: "/favicon.svg",
          badge: "/favicon.svg",
          ...options,
        });

        // Auto-cerrar despu√©s de 5 segundos
        setTimeout(() => {
          notification.close();
        }, 5000);

        return notification;
      }
      return null;
    }

    /**
     * Verifica recordatorios pendientes
     */
    async checkPendingReminders() {
      try {
        const response = await fetch("/api/quote-tracking?action=stats");
        if (response.ok) {
          const stats = await response.json();

          // Mostrar notificaci√≥n si hay seguimientos pendientes
          if (
            stats.seguimientosPendientes &&
            stats.seguimientosPendientes.length > 0
          ) {
            // Crear mensaje m√°s espec√≠fico
            const seguimientos = stats.seguimientosPendientes;
            let mensaje = "";

            if (seguimientos.length === 1) {
              const seguimiento = seguimientos[0];
              const fechaSeguimiento = new Date(seguimiento.proximoSeguimiento);
              const ahora = new Date();
              const horasRestantes = Math.ceil(
                (fechaSeguimiento.getTime() - ahora.getTime()) /
                  (1000 * 60 * 60)
              );

              // Crear mensaje m√°s detallado
              let tipoTexto = "Seguimiento";
              if (seguimiento.proximoSeguimientoTipo) {
                tipoTexto =
                  seguimiento.proximoSeguimientoTipo === "seguimiento"
                    ? "Seguimiento"
                    : seguimiento.proximoSeguimientoTipo === "vencimiento"
                      ? "Vencimiento"
                      : seguimiento.proximoSeguimientoTipo === "revision"
                        ? "Revisi√≥n"
                        : seguimiento.proximoSeguimientoTipo;
              }

              mensaje = `${tipoTexto}: ${seguimiento.numero} (${seguimiento.clienteNombre})`;

              if (seguimiento.proximoSeguimientoMensaje) {
                mensaje += ` - ${seguimiento.proximoSeguimientoMensaje}`;
              }

              if (horasRestantes > 0) {
                mensaje += ` - En ${horasRestantes}h`;
              } else {
                mensaje += " - ¬°Ya es hora!";
              }
            } else {
              mensaje = `Tienes ${seguimientos.length} seguimientos pendientes`;
            }

            this.show(mensaje, "warning", 10000);

            this.showPushNotification("Seguimientos Pendientes", mensaje);
          }

          // Mostrar notificaci√≥n si hay cotizaciones pr√≥ximas a vencer
          if (
            stats.proximosVencimientos &&
            stats.proximosVencimientos.length > 0
          ) {
            const vencimientos = stats.proximosVencimientos;
            let mensajeVencimiento = "";

            if (vencimientos.length === 1) {
              const vencimiento = vencimientos[0];
              mensajeVencimiento = `Cotizaci√≥n pr√≥xima a vencer: ${vencimiento.numero} (${vencimiento.clienteNombre}) - ${vencimiento.diasVencimiento} d√≠as`;
            } else {
              mensajeVencimiento = `${vencimientos.length} cotizaciones pr√≥ximas a vencer`;
            }

            this.show(mensajeVencimiento, "warning", 10000);
          }
        }
      } catch (error) {
        console.error("Error checking pending reminders:", error);
      }
    }
  }

  // Inicializar sistema global de notificaciones
  window.notificationSystem = new NotificationSystem();

  // Verificar recordatorios cada 5 minutos
  setInterval(
    () => {
      window.notificationSystem?.checkPendingReminders();
    },
    5 * 60 * 1000
  );

  // Verificar recordatorios al cargar la p√°gina
  setTimeout(() => {
    window.notificationSystem?.checkPendingReminders();
  }, 2000);

  // Funci√≥n global para mostrar notificaciones desde cualquier parte de la app
  window.showNotification = (
    message: string,
    type?: "success" | "error" | "info" | "warning",
    forceShow: boolean = true
  ) => {
    window.notificationSystem?.show(message, type, 5000, forceShow);
  };

  // Funci√≥n global para mostrar notificaciones push
  window.showPushNotification = (title: string, message: string) => {
    window.notificationSystem?.showPushNotification(title, message);
  };
</script>

<style>
  #notification-container {
    max-height: 80vh;
    overflow-y: auto;
  }

  #notification-container::-webkit-scrollbar {
    width: 4px;
  }

  #notification-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #notification-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
  }
</style>
